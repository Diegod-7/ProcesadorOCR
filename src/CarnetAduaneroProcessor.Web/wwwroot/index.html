<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesador de Carn√©s Aduaneros</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .document-type-selector {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .document-type-selector h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .document-type-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .document-type-btn {
            background: #e9ecef;
            color: #495057;
            border: 2px solid #dee2e6;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .document-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .document-type-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .document-type-btn.active:hover {
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-card {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .info-card h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .info-card ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-card li {
            margin: 5px 0;
            color: #424242;
        }

        .file-parts-indicator {
            background: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.9em;
            color: #e65100;
        }

        .part-indicator {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .archivos-seleccionados {
            margin-top: 10px;
        }

        .archivos-lista {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
        }

        .archivo-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .archivo-item:last-child {
            border-bottom: none;
        }

        .archivo-nombre {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }

        .archivo-tama√±o {
            color: #6c757d;
            font-size: 0.9em;
            margin: 0 10px;
        }

        .parte-indicator {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .content {
            padding: 40px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .upload-section.dragover {
            border-color: #667eea;
            background: #e8f0ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .file-size {
            color: #6c757d;
            font-size: 0.9em;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .results-section {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .result-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .result-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .result-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }

        .data-label {
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            color: #2c3e50;
            margin-top: 5px;
            word-break: break-word;
        }

        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .existing-carnets-section {
            margin-bottom: 30px;
        }

        .existing-carnets-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .carnets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .carnet-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
        }

        .carnet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .carnet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .carnet-number {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
        }

        .carnet-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-vigente {
            background: #d4edda;
            color: #155724;
        }

        .status-vencido {
            background: #f8d7da;
            color: #721c24;
        }

        .carnet-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }

        .carnet-info-item {
            display: flex;
            flex-direction: column;
        }

        .carnet-info-label {
            font-weight: bold;
            color: #495057;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .carnet-info-value {
            color: #2c3e50;
            margin-top: 2px;
        }

        .image-extraction-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }

        .image-extraction-section:hover {
            border-color: #20c997;
            background: #f0f2ff;
        }

        .image-extraction-icon {
            font-size: 3em;
            color: #20c997;
            margin-bottom: 15px;
        }

        .extract-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .extract-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(40, 167, 69, 0.3);
        }

        .extract-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .image-results {
            margin-top: 20px;
        }

        .image-result-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .image-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .image-result-title {
            font-weight: bold;
            color: #2c3e50;
        }

        .image-count {
            background: #20c997;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
        }

        .image-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .image-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .image-item img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .image-path {
            font-size: 0.8em;
            color: #6c757d;
            word-break: break-all;
        }

        .folder-input {
            width: 100%;
            max-width: 400px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .folder-input:focus {
            outline: none;
            border-color: #20c997;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
        }

        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .result-data {
                grid-template-columns: 1fr;
            }
        }

        .datos-estructurados {
            margin-top:20           padding:20        background: #f8            border-radius: 8px;
            border-left:4px solid #28        }

        .datos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1);
            gap:15            margin-top:15        }

        .dato-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .dato-item label [object Object]       font-weight: 600;
            color: #495057        }

        .dato-item .valor {
            padding: 8px12        background: white;
            border:1px solid #dee2e6;
            border-radius: 4px;
            font-family: Courier New', monospace;
            color: #212529        }

        .error-mensaje {
            margin-top: 15px;
            padding: 10px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
        }

        /* Estilos para el Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1em;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-help {
            display: block;
            margin-top: 5px;
            font-size: 0.85em;
            color: #6c757d;
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
        }

        .btn-analizar {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-analizar:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .btn-analizar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-icon {
            font-size: 1.2em;
        }

        .modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #e9ecef;
        }

        .resultados-container {
            margin-top: 20px;
        }

        .resultados-container h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .results-section {
            margin-top: 30px;
        }

        .results-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Procesador de Documentos Aduaneros</h1>
            <p>Sube PDFs de Carn√©s Aduaneros y Declaraciones de Ingreso para extraer informaci√≥n autom√°ticamente</p>
        </div>

        <div class="content">
            <!-- Selector de Tipo de Documento -->
            <div class="document-type-selector">
                <h3>Selecciona el tipo de documento a procesar:</h3>
                <div class="document-type-buttons">
                    <button class="document-type-btn active" onclick="seleccionarTipoDocumento('carne')">
                        üìÑ Carn√© Aduanero
                    </button>
                    <button class="document-type-btn" onclick="seleccionarTipoDocumento('di')">
                        üìã Declaraci√≥n de Ingreso (DI)
                    </button>
                    <button class="document-type-btn" onclick="seleccionarTipoDocumento('dr')">
                        üìÑ Documento de Recepci√≥n (DR)
                    </button>
                    <button class="document-type-btn" onclick="seleccionarTipoDocumento('guiadespacho')">
                        üì¶ Gu√≠a de Despacho
                    </button>
                </div>
            </div>

            <!-- Informaci√≥n sobre documentos divididos -->
            <div class="info-section" id="diInfoSection" style="display: none;">
                <div class="info-card">
                    <h4>üìã Informaci√≥n sobre Declaraciones de Ingreso</h4>
                    <p><strong>Nota:</strong> Los documentos DI pueden venir divididos en 2 partes (PNG). Selecciona ambas im√°genes para un procesamiento completo.</p>
                    <ul>
                        <li>Parte 1: Encabezado y datos principales</li>
                        <li>Parte 2: Descripci√≥n de mercanc√≠as y valores</li>
                    </ul>
                </div>
            </div>


            <!-- Resultados de Procesamiento Directo -->
            <div class="image-results" id="directImageResults"></div>

            <!-- Modal de An√°lisis de Documentos -->
            <div id="modalAnalisis" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>üìã An√°lisis de Documentos Aduaneros</h3>
                        <span class="close" onclick="cerrarModal()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="formAnalisis">
                            <div class="form-group">
                                <label for="inputDI">1. DI: Declaraci√≥n de Ingreso</label>
                                <input type="file" id="inputDI" accept=".pdf,.jpg,.jpeg,.png" class="form-input" multiple>
                                <small class="form-help">* Puedes seleccionar m√∫ltiples archivos si el documento est√° dividido en partes</small>
                            </div>
                            <div class="form-group">
                                <label for="inputDR">2. DR: Documento de Recepci√≥n</label>
                                <input type="file" id="inputDR" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="inputAforo">3. Selecci√≥n de Aforo</label>
                                <input type="file" id="inputAforo" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="inputComprobante">4. Comprobante de transacci√≥n</label>
                                <input type="file" id="inputComprobante" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="inputTACT">5. TACT / ADC</label>
                                <input type="file" id="inputTACT" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="inputCarne">6. Carn√© Aduanero</label>
                                <input type="file" id="inputCarne" accept=".jpg,.jpeg,.png" class="form-input" required>
                                <small class="form-help">* Requerido para an√°lisis autom√°tico</small>
                            </div>
                            <div class="form-group">
                                <label for="inputGuia">7. Gu√≠a de Despacho</label>
                                <input type="file" id="inputGuia" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            </div>
                            <div class="form-actions">
                                <button type="button" onclick="analizarDocumentos()" class="btn-analizar">
                                    <span class="btn-icon">üîç</span>
                                    Analizar Documentos
                                </button>
                                <button type="button" onclick="analizarSoloDI()" class="btn-analizar" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); margin-left: 10px;">
                                    <span class="btn-icon">üìã</span>
                                    Analizar Solo DI
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <div id="resultadosAnalisis" class="resultados-container" style="display: none;">
                            <h4>üìä Resultados del An√°lisis</h4>
                            <div id="datosExtraidos" class="datos-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://localhost:7001/api/carnetaduanero';
        
        // Variables globales
        let tipoDocumentoActual = 'carne'; // 'carne', 'di' o 'dr'
        let selectedFiles = [];
        let selectedImageFiles = [];
        let selectedDirectImageFiles = [];
        let processingFiles = new Set();
        let processingImageFiles = new Set();
        let processingDirectImageFiles = new Set();

        // Configurar drag and drop
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const imageExtractionSection = document.getElementById('imageExtractionSection');
        const imageFileInput = document.getElementById('imageFileInput');
        const directImageSection = document.getElementById('directImageSection');
        const directImageFileInput = document.getElementById('directImageFileInput');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            addFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addFiles(files);
        });

        // Configurar drag and drop para extracci√≥n de im√°genes
        imageExtractionSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageExtractionSection.classList.add('dragover');
        });

        imageExtractionSection.addEventListener('dragleave', () => {
            imageExtractionSection.classList.remove('dragover');
        });

        imageExtractionSection.addEventListener('drop', (e) => {
            e.preventDefault();
            imageExtractionSection.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf');
            addImageFiles(files);
        });

        imageFileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addImageFiles(files);
        });

        // Configurar drag and drop para procesamiento directo de im√°genes
        directImageSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            directImageSection.classList.add('dragover');
        });

        directImageSection.addEventListener('dragleave', () => {
            directImageSection.classList.remove('dragover');
        });

        directImageSection.addEventListener('drop', (e) => {
            e.preventDefault();
            directImageSection.classList.remove('dragover');
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp, iff'];
            const files = Array.from(e.dataTransfer.files).filter(file => allowedTypes.includes(file.type));
            addDirectImageFiles(files);
        });

        directImageFileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            addDirectImageFiles(files);
        });

        function addFiles(files) {
            files.forEach(file => {
                const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
                if (allowedTypes.includes(file.type) && !selectedFiles.find(f => f.name === file.name)) {
                    selectedFiles.push(file);
                }
            });
            updateFileList();
            updateProcessButton();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            // Agrupar archivos por tipo para DI
            if (tipoDocumentoActual === 'di') {
                const pdfFiles = selectedFiles.filter(f => f.type === 'application/pdf');
                const imageFiles = selectedFiles.filter(f => f.type.startsWith('image/'));
                
                // Mostrar archivos PDF
                if (pdfFiles.length > 0) {
                    const pdfSection = document.createElement('div');
                    pdfSection.innerHTML = '<h4>üìÑ Archivos PDF:</h4>';
                    pdfFiles.forEach(file => {
                        pdfSection.appendChild(createFileItem(file));
                    });
                    fileList.appendChild(pdfSection);
                }
                
                // Mostrar archivos de imagen
                if (imageFiles.length > 0) {
                    const imageSection = document.createElement('div');
                    imageSection.innerHTML = '<h4>üñºÔ∏è Archivos de Imagen:</h4>';
                    imageFiles.forEach((file, index) => {
                        const fileItem = createFileItem(file);
                        // Agregar indicador de parte si hay m√∫ltiples im√°genes
                        if (imageFiles.length > 1) {
                            const partIndicator = document.createElement('div');
                            partIndicator.className = 'file-parts-indicator';
                            partIndicator.innerHTML = `<span class="part-indicator">Parte ${index + 1}</span> ${file.name}`;
                            fileItem.querySelector('.file-name').innerHTML = partIndicator.outerHTML;
                        }
                        imageSection.appendChild(fileItem);
                    });
                    fileList.appendChild(imageSection);
                }
            } else {
                // Mostrar archivos normalmente para carn√©s
                selectedFiles.forEach(file => {
                    fileList.appendChild(createFileItem(file));
                });
            }
        }

        function createFileItem(file) {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${formatFileSize(file.size)}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-${file.name}" style="width: 0%"></div>
                    </div>
                </div>
                <button class="upload-btn" onclick="removeFile('${file.name}')" style="background: #dc3545;">
                    Eliminar
                </button>
            `;
            return fileItem;
        }

        function removeFile(fileName) {
            selectedFiles = selectedFiles.filter(file => file.name !== fileName);
            updateFileList();
            updateProcessButton();
        }

        function updateProcessButton() {
            const processBtn = document.getElementById('processBtn');
            let isValid = false;
            
            if (tipoDocumentoActual === 'di') {
                // Para DI debe tener exactamente 2 archivos PNG
                const pngFiles = selectedFiles.filter(f => f.type === 'image/png');
                isValid = pngFiles.length === 2;
                
                if (pngFiles.length > 0 && pngFiles.length !== 2) {
                    // Mostrar mensaje de validaci√≥n
                    const fileList = document.getElementById('fileList');
                    const validationMsg = document.createElement('div');
                    validationMsg.className = 'error-message';
                    validationMsg.innerHTML = `‚ö†Ô∏è Para Declaraci√≥n de Ingreso (DI) se requieren exactamente 2 archivos PNG. Actualmente tienes ${pngFiles.length} archivo(s).`;
                    
                    // Remover mensaje anterior si existe
                    const existingMsg = fileList.querySelector('.error-message');
                    if (existingMsg) {
                        existingMsg.remove();
                    }
                    
                    fileList.appendChild(validationMsg);
                }
            } else if (tipoDocumentoActual === 'dr') {
                // Para DR debe tener exactamente 1 archivo de imagen
                const imageFiles = selectedFiles.filter(f => f.type.startsWith('image/'));
                isValid = imageFiles.length === 1;
                
                if (imageFiles.length > 0 && imageFiles.length !== 1) {
                    // Mostrar mensaje de validaci√≥n
                    const fileList = document.getElementById('fileList');
                    const validationMsg = document.createElement('div');
                    validationMsg.className = 'error-message';
                    validationMsg.innerHTML = `‚ö†Ô∏è Para Documento de Recepci√≥n (DR) se requiere exactamente 1 archivo de imagen. Actualmente tienes ${imageFiles.length} archivo(s).`;
                    
                    // Remover mensaje anterior si existe
                    const existingMsg = fileList.querySelector('.error-message');
                    if (existingMsg) {
                        existingMsg.remove();
                    }
                    
                    fileList.appendChild(validationMsg);
                }
            } else {
                // Para otros tipos, solo verificar que haya archivos
                isValid = selectedFiles.length > 0;
            }
            
            processBtn.disabled = !isValid;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processFiles() {
            if (selectedFiles.length === 0) return;

            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="loading"></span> Procesando...';

            const results = [];

            // Determinar el endpoint seg√∫n el tipo de documento
            let endpoint = '';
            if (tipoDocumentoActual === 'carne') {
                endpoint = `${API_BASE_URL}/CarnetAduanero/procesar`;
            } else if (tipoDocumentoActual === 'di') {
                endpoint = `${API_BASE_URL}/DeclaracionIngreso/procesar`;
            } else if (tipoDocumentoActual === 'dr') {
                endpoint = `${API_BASE_URL}/DocumentoRecepcion/procesar`;
            }

            for (const file of selectedFiles) {
                if (processingFiles.has(file.name)) continue;
                
                processingFiles.add(file.name);
                updateProgress(file.name, 0);

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    updateProgress(file.name, 25);

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: formData
                    });

                    updateProgress(file.name, 75);

                    if (response.ok) {
                        const result = await response.json();
                        results.push({ file, result, success: true });
                        updateProgress(file.name, 100);
                    } else {
                        const error = await response.json();
                        results.push({ file, error: error.message, success: false });
                        updateProgress(file.name, 100);
                    }
                } catch (error) {
                    results.push({ file, error: error.message, success: false });
                    updateProgress(file.name, 100);
                } finally {
                    processingFiles.delete(file.name);
                }
            }

            displayResults(results);
            updateStats(results);
            
            // Recargar datos despu√©s de procesar solo para carn√©s
            if (tipoDocumentoActual === 'carne') {
                loadStats();
                loadExistingCarnets();
            }
            
            processBtn.disabled = false;
            processBtn.innerHTML = getProcessButtonText();
        }

        function getProcessButtonText() {
            switch (tipoDocumentoActual) {
                case 'di':
                    return 'Procesar Declaraciones de Ingreso';
                case 'dr':
                    return 'Procesar Documentos de Recepci√≥n';
                default:
                    return 'Procesar Carn√©s Aduaneros';
            }
        }

        function updateProgress(fileName, percentage) {
            const progressBar = document.getElementById(`progress-${fileName}`);
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
        }

        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            const titulo = getResultsTitle();
            resultsSection.innerHTML = `<h3>${titulo}</h3>`;

            results.forEach(({ file, result, error, success }) => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';

                if (success) {
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <div class="result-title">‚úÖ ${file.name}</div>
                            <div class="result-status status-success">Exitoso</div>
                        </div>
                        <div class="result-data">
                            ${getResultDataHTML(result)}
                        </div>
                    `;
                } else {
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <div class="result-title">‚ùå ${file.name}</div>
                            <div class="result-status status-error">Error</div>
                        </div>
                        <div class="error-message">
                            <strong>Error:</strong> ${error}
                        </div>
                    `;
                }

                resultsSection.appendChild(resultCard);
            });
        }

        function getResultsTitle() {
            switch (tipoDocumentoActual) {
                case 'di':
                    return 'Resultados - Declaraciones de Ingreso';
                case 'dr':
                    return 'Resultados - Documentos de Recepci√≥n';
                default:
                    return 'Resultados - Carn√©s Aduaneros';
            }
        }

        function getResultDataHTML(result) {
            if (tipoDocumentoActual === 'dr') {
                return `
                    <div class="data-item">
                        <div class="data-label">N√∫mero de DR</div>
                        <div class="data-value">${result.numeroDocumento || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Situaci√≥n</div>
                        <div class="data-value">${result.situacionDocumento || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Manifiesto</div>
                        <div class="data-value">${result.numeroManifiesto || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Fecha Manifiesto SNA</div>
                        <div class="data-value">${result.fechaManifiestoSna ? new Date(result.fechaManifiestoSna).toLocaleDateString('es-CL') : 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Fecha Inicio Almacenaje</div>
                        <div class="data-value">${result.fechaInicioAlmacenaje ? new Date(result.fechaInicioAlmacenaje).toLocaleDateString('es-CL') : 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Tipo de Documento</div>
                        <div class="data-value">${result.tipoDocumento || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">BL Armador</div>
                        <div class="data-value">${result.blArmador || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Consignatario</div>
                        <div class="data-value">${result.consignatario || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">RUT Consignatario</div>
                        <div class="data-value">${result.rutConsignatario || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Direcci√≥n</div>
                        <div class="data-value">${result.direccionConsignatario || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Nave/Viaje</div>
                        <div class="data-value">${result.naveViaje || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">L√≠nea Operadora</div>
                        <div class="data-value">${result.lineaOperadora || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Puerto Origen</div>
                        <div class="data-value">${result.puertoOrigen || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Puerto Descarga</div>
                        <div class="data-value">${result.puertoDescarga || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Almac√©n</div>
                        <div class="data-value">${result.almacen || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Destino Carga</div>
                        <div class="data-value">${result.destinoCarga || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Zona</div>
                        <div class="data-value">${result.zona || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Guarda Almac√©n</div>
                        <div class="data-value">${result.guardaAlmacen || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">RUT Emisor</div>
                        <div class="data-value">${result.rutEmisor || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Fecha Emisi√≥n</div>
                        <div class="data-value">${result.fechaEmision || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Medio Emisi√≥n</div>
                        <div class="data-value">${result.medioEmision || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Confianza</div>
                        <div class="data-value">${result.confianzaExtraccion ? (result.confianzaExtraccion * 100).toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                `;
            } else if (tipoDocumentoActual === 'di') {
                return `
                    <div class="data-item">
                        <div class="data-label">N√∫mero de DI</div>
                        <div class="data-value">${result.numeroDI || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Fecha de Declaraci√≥n</div>
                        <div class="data-value">${result.fechaDeclaracion ? new Date(result.fechaDeclaracion).toLocaleDateString('es-CL') : 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Importador</div>
                        <div class="data-value">${result.importador || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">RUT Importador</div>
                        <div class="data-value">${result.rutImportador || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Aduana</div>
                        <div class="data-value">${result.aduana || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Estado</div>
                        <div class="data-value">${result.estado || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Confianza</div>
                        <div class="data-value">${result.confianzaExtraccion ? (result.confianzaExtraccion * 100).toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                `;
            } else {
                return `
                    <div class="data-item">
                        <div class="data-label">N√∫mero de Carn√©</div>
                        <div class="data-value">${result.numeroCarnet || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Titular</div>
                        <div class="data-value">${result.nombreTitular || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">RUT</div>
                        <div class="data-value">${result.rut || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Fecha de Emisi√≥n</div>
                        <div class="data-value">${result.fechaEmision ? new Date(result.fechaEmision).toLocaleDateString('es-CL') : 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Resoluci√≥n</div>
                        <div class="data-value">${result.resolucion || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">AGAD Cod</div>
                        <div class="data-value">${result.agadCod || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Entidad Emisora</div>
                        <div class="data-value">${result.entidadEmisora || 'No encontrado'}</div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">Confianza</div>
                        <div class="data-value">${result.confianzaExtraccion ? (result.confianzaExtraccion * 100).toFixed(1) + '%' : 'N/A'}</div>
                    </div>
                `;
            }
        }

        function updateStats(results) {
            const total = results.length;
            const successful = results.filter(r => r.success).length;
            const errors = results.filter(r => !r.success).length;

            document.getElementById('totalProcessed').textContent = total;
            document.getElementById('successful').textContent = successful;
            document.getElementById('errors').textContent = errors;
            document.getElementById('pending').textContent = 0;
        }

        // Cargar estad√≠sticas iniciales
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/estadisticas`);
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalProcessed').textContent = stats.totalCarnets;
                    document.getElementById('successful').textContent = stats.carnetsVigentes;
                    document.getElementById('errors').textContent = stats.carnetsVencidos;
                    document.getElementById('pending').textContent = stats.carnetsSinEstado;
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Cargar carn√©s existentes
        async function loadExistingCarnets() {
            try {
                const response = await fetch(`${API_BASE_URL}?pageSize=100`);
                if (response.ok) {
                    const carnets = await response.json();
                    displayExistingCarnets(carnets);
                }
            } catch (error) {
                console.error('Error cargando carn√©s existentes:', error);
            }
        }

        // Mostrar carn√©s existentes
        function displayExistingCarnets(carnets) {
            const grid = document.getElementById('carnetsGrid');
            grid.innerHTML = '';

            carnets.forEach(carnet => {
                const card = document.createElement('div');
                card.className = 'carnet-card';
                
                const statusClass = carnet.estado === 'Vigente' ? 'status-vigente' : 'status-vencido';
                const statusText = carnet.estado || 'Sin Estado';
                
                card.innerHTML = `
                    <div class="carnet-header">
                        <div class="carnet-number">${carnet.numeroCarnet}</div>
                        <div class="carnet-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="carnet-info">
                        <div class="carnet-info-item">
                            <div class="carnet-info-label">Titular</div>
                            <div class="carnet-info-value">${carnet.nombreTitular} ${carnet.apellidosTitular || ''}</div>
                        </div>
                        <div class="carnet-info-item">
                            <div class="carnet-info-label">RUT</div>
                            <div class="carnet-info-value">${carnet.rut}</div>
                        </div>
                        <div class="carnet-info-item">
                            <div class="carnet-info-label">Emisi√≥n</div>
                            <div class="carnet-info-value">${new Date(carnet.fechaEmision).toLocaleDateString('es-CL')}</div>
                        </div>
                        <div class="carnet-info-item">
                            <div class="carnet-info-label">Vencimiento</div>
                            <div class="carnet-info-value">${carnet.fechaVencimiento ? new Date(carnet.fechaVencimiento).toLocaleDateString('es-CL') : 'N/A'}</div>
                        </div>
                        <div class="carnet-info-item">
                            <div class="carnet-info-label">Resoluci√≥n</div>
                            <div class="carnet-info-value">${carnet.resolucion || 'N/A'}</div>
                        </div>
                        <div class="carnet-info-item">
                            <div class="carnet-info-label">AGAD Cod</div>
                            <div class="carnet-info-value">${carnet.agadCod || 'N/A'}</div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        async function extractImages() {
            if (selectedImageFiles.length === 0) return;

            const extractBtn = document.getElementById('extractImagesBtn');
            extractBtn.disabled = true;
            extractBtn.innerHTML = '<span class="loading"></span> Extrayendo...';

            const results = [];

            for (const file of selectedImageFiles) {
                if (processingImageFiles.has(file.name)) continue;
                
                processingImageFiles.add(file.name);

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_BASE_URL}/extraer-imagenes`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        results.push({ file, result, success: true });
                    } else {
                        const error = await response.json();
                        results.push({ file, error: error.message, success: false });
                    }
                } catch (error) {
                    results.push({ file, error: error.message, success: false });
                } finally {
                    processingImageFiles.delete(file.name);
                }
            }

            displayImageResults(results);
            
            extractBtn.disabled = false;
            extractBtn.innerHTML = 'Extraer Im√°genes';
        }

        function displayImageResults(results) {
            const imageResults = document.getElementById('imageResults');
            imageResults.innerHTML = '<h3>Resultados de Extracci√≥n de Im√°genes</h3>';

            results.forEach(({ file, result, error, success }) => {
                const resultCard = document.createElement('div');
                resultCard.className = 'image-result-card';

                if (success) {
                    resultCard.innerHTML = `
                        <div class="image-result-header">
                            <div class="image-result-title">‚úÖ ${file.name}</div>
                            <div class="image-count">${result.imagenes.length} im√°genes</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Carpeta Destino</div>
                            <div class="data-value">${result.carpetaDestino}</div>
                        </div>
                        <div class="image-list">
                            ${result.imagenes.map((imagePath, index) => `
                                <div class="image-item">
                                    <img src="file://${imagePath}" alt="Imagen ${index + 1}" onerror="this.style.display='none'">
                                    <div class="image-path">${imagePath.split('\\').pop()}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    resultCard.innerHTML = `
                        <div class="image-result-header">
                            <div class="image-result-title">‚ùå ${file.name}</div>
                            <div class="image-count">Error</div>
                        </div>
                        <div class="error-message">
                            <strong>Error:</strong> ${error}
                        </div>
                    `;
                }

                imageResults.appendChild(resultCard);
            });
        }

        function addImageFiles(files) {
            files.forEach(file => {
                if (file.type === 'application/pdf' && !selectedImageFiles.find(f => f.name === file.name)) {
                    selectedImageFiles.push(file);
                }
            });
            updateImageFileList();
            updateExtractButton();
        }

        function updateImageFileList() {
            const imageResults = document.getElementById('imageResults');
            imageResults.innerHTML = '';

            if (selectedImageFiles.length > 0) {
                const fileList = document.createElement('div');
                fileList.innerHTML = '<h4>Archivos seleccionados para extracci√≥n de im√°genes:</h4>';
                
                selectedImageFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="extract-btn" onclick="removeImageFile('${file.name}')" style="background: #dc3545;">
                            Eliminar
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                imageResults.appendChild(fileList);
            }
        }

        function removeImageFile(fileName) {
            selectedImageFiles = selectedImageFiles.filter(file => file.name !== fileName);
            updateImageFileList();
            updateExtractButton();
        }

        function updateExtractButton() {
            const extractBtn = document.getElementById('extractImagesBtn');
            extractBtn.disabled = selectedImageFiles.length === 0;
        }

        async function processDirectImages() {
            if (selectedDirectImageFiles.length === 0) return;

            const processBtn = document.getElementById('processImagesBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="loading"></span> Procesando...';

            const results = [];

            for (const file of selectedDirectImageFiles) {
                if (processingDirectImageFiles.has(file.name)) continue;
                
                processingDirectImageFiles.add(file.name);

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch(`${API_BASE_URL}/procesar-imagen`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        results.push({ file, result, success: true });
                    } else {
                        const error = await response.json();
                        results.push({ file, error: error.message, success: false });
                    }
                } catch (error) {
                    results.push({ file, error: error.message, success: false });
                } finally {
                    processingDirectImageFiles.delete(file.name);
                }
            }

            displayDirectImageResults(results);
            
            processBtn.disabled = false;
            processBtn.innerHTML = 'Extraer Texto';
        }

        async function procesarTextoOcr(textoOcr) {
            const response = await fetch(`${API_BASE_URL}/procesar-texto-ocr`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ textoOcr })
            });
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.mensaje || 'Error al procesar el texto OCR');
            }
            return await response.json();
        }

        function mostrarDatosEstructurados(datos, contenedor) {
            const datosEstructuradosHTML = `
                <div class="datos-estructurados">
                    <h4>üìã Datos Extra√≠dos del Carn√© Aduanero</h4>
                    <div class="datos-grid">
                        <div class="dato-item">
                            <label>T√≠tulo:</label>
                            <span class="valor">${datos.titulo || 'No encontrado'}</span>
                        </div>
                        <div class="dato-item">
                            <label>Nombre Completo:</label>
                            <span class="valor">${datos.nombreCompleto || 'No encontrado'}</span>
                        </div>
                        <div class="dato-item">
                            <label>RUT:</label>
                            <span class="valor">${datos.rut || 'No encontrado'}</span>
                        </div>
                        <div class="dato-item">
                            <label>N√∫mero de Carn√©:</label>
                            <span class="valor">${datos.numeroCarne || 'No encontrado'}</span>
                        </div>
                        <div class="dato-item">
                            <label>Fecha de Emisi√≥n:</label>
                            <span class="valor">${datos.fechaEmision || 'No encontrado'}</span>
                        </div>
                        <div class="dato-item">
                            <label>Resoluci√≥n:</label>
                            <span class="valor">${datos.resolucion || 'No encontrado'}</span>
                        </div>
                    </div>
                    ${datos.mensajeError ? `<div class="error-mensaje">‚ö†Ô∏è ${datos.mensajeError}</div>` : ''}
                </div>
            `;
            contenedor.insertAdjacentHTML('beforeend', datosEstructuradosHTML);
        }

        // Modificar displayDirectImageResults para mostrar datos estructurados
        function displayDirectImageResults(results) {
            const directImageResults = document.getElementById('directImageResults');
            directImageResults.innerHTML = '<h3>Resultados de OCR en Im√°genes</h3>';

            results.forEach(({ file, result, error, success }) => {
                const resultCard = document.createElement('div');
                resultCard.className = 'image-result-card';

                if (success) {
                    resultCard.innerHTML = `
                        <div class="image-result-header">
                            <div class="image-result-title">‚úÖ ${file.name}</div>
                            <div class="image-count">${result.metodo}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">M√©todo Utilizado</div>
                            <div class="data-value">${result.metodo}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">Texto Extra√≠do</div>
                            <div class="data-value" style="white-space: pre-wrap; max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">${result.texto}</div>
                        </div>
                    `;
                    // Llamar al endpoint de datos estructurados y mostrar debajo
                    procesarTextoOcr(result.texto)
                        .then(datos => mostrarDatosEstructurados(datos, resultCard))
                        .catch(err => {
                            resultCard.innerHTML += `<div class="error-mensaje">No se pudieron extraer los datos estructurados: ${err.message}</div>`;
                        });
                } else {
                    resultCard.innerHTML = `
                        <div class="image-result-header">
                            <div class="image-result-title">‚ùå ${file.name}</div>
                            <div class="image-count">Error</div>
                        </div>
                        <div class="error-message">
                            <strong>Error:</strong> ${error}
                        </div>
                    `;
                }

                directImageResults.appendChild(resultCard);
            });
        }

        function addDirectImageFiles(files) {
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/bmp, iff'];
            files.forEach(file => {
                if (allowedTypes.includes(file.type) && !selectedDirectImageFiles.find(f => f.name === file.name)) {
                    selectedDirectImageFiles.push(file);
                }
            });
            updateDirectImageFileList();
            updateProcessImagesButton();
        }

        function updateDirectImageFileList() {
            const directImageResults = document.getElementById('directImageResults');
            directImageResults.innerHTML = '';

            if (selectedDirectImageFiles.length > 0) {
                const fileList = document.createElement('div');
                fileList.innerHTML = '<h4>Im√°genes seleccionadas para OCR:</h4>';
                
                selectedDirectImageFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="extract-btn" onclick="removeDirectImageFile('${file.name}')" style="background: #dc3545;">
                            Eliminar
                        </button>
                    `;
                    fileList.appendChild(fileItem);
                });
                
                directImageResults.appendChild(fileList);
            }
        }

        function removeDirectImageFile(fileName) {
            selectedDirectImageFiles = selectedDirectImageFiles.filter(file => file.name !== fileName);
            updateDirectImageFileList();
            updateProcessImagesButton();
        }

        function updateProcessImagesButton() {
            const processBtn = document.getElementById('processImagesBtn');
            processBtn.disabled = selectedDirectImageFiles.length === 0;
        }

        // Funciones para el Modal de An√°lisis
        function abrirModal() {
            document.getElementById('modalAnalisis').style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modalAnalisis').style.display = 'none';
            document.getElementById('resultadosAnalisis').style.display = 'none';
            document.getElementById('formAnalisis').reset();
            
            // Limpiar archivos seleccionados mostrados
            const archivosContainer = document.getElementById('inputDIArchivos');
            if (archivosContainer) {
                archivosContainer.innerHTML = '';
            }
        }
        // Funci√≥n para analizar documentos de tipo DR usando la API de campos cr√≠ticos
        async function analizarSoloDR() {
            const drFileInput = document.getElementById('inputDR');
            const drFile = drFileInput && drFileInput.files.length > 0 ? drFileInput.files[0] : null;

            if (!drFile) {
                alert('Por favor, selecciona el documento DR (campo requerido)');
                return;
            }

            // Validar extensi√≥n permitida (solo PNG, JPG, JPEG)
            const allowedExtensions = ['.png', '.jpg', '.jpeg'];
            const fileName = drFile.name || '';
            const fileExtension = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                alert('Solo se permiten archivos PNG, JPG o JPEG para el Documento de Recepci√≥n (DR)');
                return;
            }

            const btnAnalizar = document.querySelector('.btn-analizar');
            btnAnalizar.disabled = true;
            btnAnalizar.innerHTML = '<span class="loading"></span> Analizando...';

            try {
                const formData = new FormData();
                formData.append('file', drFile);

                // Llamar a la API de campos cr√≠ticos de DR
                const response = await fetch(`${API_BASE_URL}/dr/campos-criticos`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const camposCriticos = await response.json();

                    // Mostrar resultados espec√≠ficos para DR (campos cr√≠ticos)
                    mostrarResultadosAnalisisDR(camposCriticos);
                } else {
                    let errorMsg = 'Error al procesar el DR';
                    try {
                        const error = await response.json();
                        errorMsg = error.error || error.message || errorMsg;
                    } catch {}
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al analizar el documento DR: ' + (error.message || error));
            } finally {
                btnAnalizar.disabled = false;
                btnAnalizar.innerHTML = '<span class="btn-icon">üîç</span> Analizar Documentos';
            }
        }

        // Funci√≥n para mostrar resultados de an√°lisis de DR
        function mostrarResultadosAnalisisDR(datosEstructurados, resultadoOCR) {
            const resultadosContainer = document.getElementById('resultadosAnalisis');
            resultadosContainer.innerHTML = '';

            // Ejemplo de renderizado de datos estructurados de DR
            const drHtml = `
                <h4>Resultados DR</h4>
                <div><strong>Datos extra√≠dos:</strong></div>
                <pre>${JSON.stringify(datosEstructurados, null, 2)}</pre>
                <div><strong>Texto OCR completo:</strong></div>
                <pre>${resultadoOCR.texto}</pre>
            `;
            resultadosContainer.innerHTML = drHtml;
            resultadosContainer.style.display = 'block';
        }

        // Funci√≥n para procesar el texto OCR espec√≠fico de DR (puedes personalizar la l√≥gica)
        async function procesarTextoOcrDR(textoOcr) {
            // Aqu√≠ puedes implementar la l√≥gica de extracci√≥n de datos del texto OCR de DR
            // Por ahora, retornamos un objeto de ejemplo
            return {
                campoEjemplo: 'Valor extra√≠do',
                textoOriginal: textoOcr
            };
        }

        // Funci√≥n para analizar documentos de tipo TACT/ADC
        async function analizarSoloTACT() {
            const tactFileInput = document.getElementById('inputTACT');
            const tactFile = tactFileInput && tactFileInput.files.length > 0 ? tactFileInput.files[0] : null;

            if (!tactFile) {
                alert('Por favor, selecciona el documento TACT/ADC (campo requerido)');
                return;
            }

            // Validar extensi√≥n permitida (solo PNG, JPG, JPEG)
            const allowedExtensions = ['.png', '.jpg', '.jpeg'];
            const fileName = tactFile.name || '';
            const fileExtension = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                alert('Solo se permiten archivos PNG, JPG o JPEG para el documento TACT/ADC');
                return;
            }

            const btnAnalizar = document.querySelector('.btn-analizar');
            btnAnalizar.disabled = true;
            btnAnalizar.innerHTML = '<span class="loading"></span> Analizando TACT/ADC...';

            try {
                const formData = new FormData();
                formData.append('file', tactFile);

                // Llamar a la API de TACT/ADC
                const response = await fetch(`https://localhost:7001/api/TactAdc/procesar`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const resultado = await response.json();
                    // Mostrar resultados espec√≠ficos para TACT/ADC
                    mostrarResultadosTACT(resultado);
                } else {
                    let errorMsg = 'Error al procesar el TACT/ADC';
                    try {
                        const error = await response.json();
                        errorMsg = error.message || errorMsg;
                    } catch {}
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al analizar el documento TACT/ADC: ' + (error.message || error));
            } finally {
                btnAnalizar.disabled = false;
                btnAnalizar.innerHTML = '<span class="btn-icon">üîç</span> Analizar Documentos';
            }
        }

        // Funci√≥n para mostrar resultados de an√°lisis de TACT/ADC
        function mostrarResultadosTACT(resultado) {
            const resultadosContainer = document.getElementById('resultadosAnalisis');
            const datosExtraidos = document.getElementById('datosExtraidos');

            datosExtraidos.innerHTML = `
                <div class="dato-item">
                    <label>N√∫mero TATC:</label>
                    <span class="valor">${resultado.numeroTatc || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>N√∫mero de Contenedor:</label>
                    <span class="valor">${resultado.numeroContenedor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>N√∫mero de Sellos:</label>
                    <span class="valor">${resultado.numeroSellos || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Empresa Emisora:</label>
                    <span class="valor">${resultado.empresaEmisora || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Direcci√≥n Empresa:</label>
                    <span class="valor">${resultado.direccionEmpresa || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT Emisor:</label>
                    <span class="valor">${resultado.rutEmisor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Emisi√≥n:</label>
                    <span class="valor">${resultado.fechaEmision || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Tipo de Documento:</label>
                    <span class="valor">${resultado.tipoDocumento || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>BL Armador:</label>
                    <span class="valor">${resultado.blArmador || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Consignatario:</label>
                    <span class="valor">${resultado.consignatario || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT Consignatario:</label>
                    <span class="valor">${resultado.rutConsignatario || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Direcci√≥n Consignatario:</label>
                    <span class="valor">${resultado.direccionConsignatario || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Forwarder:</label>
                    <span class="valor">${resultado.forwarder || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>L√≠nea Operadora:</label>
                    <span class="valor">${resultado.lineaOperadora || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Servicio Almacenaje:</label>
                    <span class="valor">${resultado.servicioAlmacenaje || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Guarda Almac√©n:</label>
                    <span class="valor">${resultado.guardaAlmacen || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT Guarda Almac√©n:</label>
                    <span class="valor">${resultado.rutGuardaAlmacen || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Puerto Origen:</label>
                    <span class="valor">${resultado.puertoOrigen || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Puerto Descarga:</label>
                    <span class="valor">${resultado.puertoDescarga || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Puerto Embarque:</label>
                    <span class="valor">${resultado.puertoEmbarque || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Puerto Destino:</label>
                    <span class="valor">${resultado.puertoDestino || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Puerto Transbordo:</label>
                    <span class="valor">${resultado.puertoTransbordo || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Tipo de Bulto:</label>
                    <span class="valor">${resultado.tipoBulto || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Cantidad:</label>
                    <span class="valor">${resultado.cantidad || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Peso:</label>
                    <span class="valor">${resultado.peso || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Volumen:</label>
                    <span class="valor">${resultado.volumen || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Estado:</label>
                    <span class="valor">${resultado.estado || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Estado de Extracci√≥n:</label>
                    <span class="valor">${resultado.esValido ? '‚úÖ Documento v√°lido' : '‚ö†Ô∏è Documento incompleto'}</span>
                </div>
                <div class="dato-item">
                    <label>M√©todo de Extracci√≥n:</label>
                    <span class="valor">${resultado.metodoExtraccion || 'No especificado'}</span>
                </div>
                <div class="dato-item">
                    <label>Confianza de Extracci√≥n:</label>
                    <span class="valor">${resultado.confianzaExtraccion ? (resultado.confianzaExtraccion * 100).toFixed(1) + '%' : 'No especificado'}</span>
                </div>
            `;

            resultadosContainer.style.display = 'block';
        }

        // Funci√≥n para analizar documentos de tipo Comprobante de Transacci√≥n
        async function analizarSoloComprobante() {
            const comprobanteFileInput = document.getElementById('inputComprobante');
            const comprobanteFile = comprobanteFileInput && comprobanteFileInput.files.length > 0 ? comprobanteFileInput.files[0] : null;

            if (!comprobanteFile) {
                alert('Por favor, selecciona el documento de Comprobante de Transacci√≥n (campo requerido)');
                return;
            }

            // Validar extensi√≥n permitida (solo PNG, JPG, JPEG)
            const allowedExtensions = ['.png', '.jpg', '.jpeg'];
            const fileName = comprobanteFile.name || '';
            const fileExtension = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                alert('Solo se permiten archivos PNG, JPG o JPEG para el documento de Comprobante de Transacci√≥n');
                return;
            }

            const btnAnalizar = document.querySelector('.btn-analizar');
            btnAnalizar.disabled = true;
            btnAnalizar.innerHTML = '<span class="loading"></span> Analizando Comprobante...';

            try {
                const formData = new FormData();
                formData.append('file', comprobanteFile);

                // Llamar a la API de Comprobante de Transacci√≥n
                const response = await fetch(`https://localhost:7001/api/ComprobanteTransaccion/procesar`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const resultado = await response.json();
                    // Mostrar resultados espec√≠ficos para Comprobante de Transacci√≥n
                    mostrarResultadosComprobante(resultado);
                } else {
                    let errorMsg = 'Error al procesar el Comprobante de Transacci√≥n';
                    try {
                        const error = await response.json();
                        errorMsg = error.message || errorMsg;
                    } catch {}
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al analizar el documento de Comprobante de Transacci√≥n: ' + (error.message || error));
            } finally {
                btnAnalizar.disabled = false;
                btnAnalizar.innerHTML = '<span class="btn-icon">üîç</span> Analizar Documentos';
            }
        }

        // Funci√≥n para mostrar resultados de an√°lisis de Comprobante de Transacci√≥n
        function mostrarResultadosComprobante(resultado) {
            const resultadosContainer = document.getElementById('resultadosAnalisis');
            const datosExtraidos = document.getElementById('datosExtraidos');

            datosExtraidos.innerHTML = `
                <div class="dato-item">
                    <label>N√∫mero de Folio:</label>
                    <span class="valor">${resultado.numeroFolio || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Total Pagado:</label>
                    <span class="valor">${resultado.totalPagado ? '$' + resultado.totalPagado.toLocaleString('es-CL') : 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT:</label>
                    <span class="valor">${resultado.rut || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Formulario:</label>
                    <span class="valor">${resultado.formulario || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Vencimiento:</label>
                    <span class="valor">${resultado.fechaVencimiento || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Moneda de Pago:</label>
                    <span class="valor">${resultado.monedaPago || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Pago:</label>
                    <span class="valor">${resultado.fechaPago || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Instituci√≥n Recaudadora:</label>
                    <span class="valor">${resultado.institucionRecaudadora || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Identificador de Transacci√≥n:</label>
                    <span class="valor">${resultado.identificadorTransaccion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>C√≥digo de Barras:</label>
                    <span class="valor">${resultado.codigoBarras || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>N√∫mero de Referencia:</label>
                    <span class="valor">${resultado.numeroReferencia || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Estado de Extracci√≥n:</label>
                    <span class="valor">${resultado.esValido ? '‚úÖ Documento v√°lido' : '‚ö†Ô∏è Documento incompleto'}</span>
                </div>
                <div class="dato-item">
                    <label>M√©todo de Extracci√≥n:</label>
                    <span class="valor">${resultado.metodoExtraccion || 'No especificado'}</span>
                </div>
                <div class="dato-item">
                    <label>Confianza de Extracci√≥n:</label>
                    <span class="valor">${resultado.confianzaExtraccion ? (resultado.confianzaExtraccion * 100).toFixed(1) + '%' : 'No especificado'}</span>
                </div>
            `;

            resultadosContainer.style.display = 'block';
        }

        // Funci√≥n para analizar documentos de tipo Gu√≠a de Despacho
        async function analizarSoloGuiaDespacho() {
            const guiaFileInput = document.getElementById('inputGuia');
            const guiaFile = guiaFileInput && guiaFileInput.files.length > 0 ? guiaFileInput.files[0] : null;

            if (!guiaFile) {
                alert('Por favor, selecciona el documento de Gu√≠a de Despacho (campo requerido)');
                return;
            }

            // Validar extensi√≥n permitida (solo PNG, JPG, JPEG)
            const allowedExtensions = ['.png', '.jpg', '.jpeg'];
            const fileName = guiaFile.name || '';
            const fileExtension = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
            if (!allowedExtensions.includes(fileExtension)) {
                alert('Solo se permiten archivos PNG, JPG o JPEG para el documento de Gu√≠a de Despacho');
                return;
            }

            const btnAnalizar = document.querySelector('.btn-analizar');
            btnAnalizar.disabled = true;
            btnAnalizar.innerHTML = '<span class="loading"></span> Analizando Gu√≠a de Despacho...';

            try {
                const formData = new FormData();
                formData.append('file', guiaFile);

                // Llamar a la API de Gu√≠a de Despacho
                const response = await fetch(`https://localhost:7001/api/GuiaDespacho/procesar`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const resultado = await response.json();
                    // Mostrar resultados espec√≠ficos para Gu√≠a de Despacho
                    mostrarResultadosGuiaDespacho(resultado);
                } else {
                    let errorMsg = 'Error al procesar la Gu√≠a de Despacho';
                    try {
                        const error = await response.json();
                        errorMsg = error.message || errorMsg;
                    } catch {}
                    alert(errorMsg);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al analizar el documento de Gu√≠a de Despacho: ' + (error.message || error));
            } finally {
                btnAnalizar.disabled = false;
                btnAnalizar.innerHTML = '<span class="btn-icon">üîç</span> Analizar Documentos';
            }
        }

        // Funci√≥n para mostrar resultados de an√°lisis de Gu√≠a de Despacho
        function mostrarResultadosGuiaDespacho(resultado) {
            const resultadosContainer = document.getElementById('resultadosAnalisis');
            const datosExtraidos = document.getElementById('datosExtraidos');

            datosExtraidos.innerHTML = `
                <div class="dato-item">
                    <label>N√∫mero de Gu√≠a:</label>
                    <span class="valor">${resultado.numeroGuia || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT del Emisor:</label>
                    <span class="valor">${resultado.rutEmisor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha del Documento:</label>
                    <span class="valor">${resultado.fechaDocumento || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Nombre del Emisor:</label>
                    <span class="valor">${resultado.nombreEmisor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Giro del Emisor:</label>
                    <span class="valor">${resultado.giroEmisor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Direcci√≥n del Emisor:</label>
                    <span class="valor">${resultado.direccionEmisor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Nombre del Receptor:</label>
                    <span class="valor">${resultado.nombreReceptor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT del Receptor:</label>
                    <span class="valor">${resultado.rutReceptor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Giro del Receptor:</label>
                    <span class="valor">${resultado.giroReceptor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Direcci√≥n del Receptor:</label>
                    <span class="valor">${resultado.direccionReceptor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Ciudad del Receptor:</label>
                    <span class="valor">${resultado.ciudadReceptor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Comuna del Receptor:</label>
                    <span class="valor">${resultado.comunaReceptor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Transportista:</label>
                    <span class="valor">${resultado.transportista || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Patente del Veh√≠culo:</label>
                    <span class="valor">${resultado.patenteVehiculo || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Chofer:</label>
                    <span class="valor">${resultado.chofer || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Ubicaci√≥n:</label>
                    <span class="valor">${resultado.ubicacion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Origen:</label>
                    <span class="valor">${resultado.origen || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Destino:</label>
                    <span class="valor">${resultado.destino || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>N√∫mero de Despacho:</label>
                    <span class="valor">${resultado.numeroDespacho || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Despacho:</label>
                    <span class="valor">${resultado.fechaDespacho || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Aduana:</label>
                    <span class="valor">${resultado.aduana || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Referencia:</label>
                    <span class="valor">${resultado.referencia || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Tipo de Operaci√≥n:</label>
                    <span class="valor">${resultado.tipoOperacion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>N√∫mero DAU:</label>
                    <span class="valor">${resultado.numeroDAU || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Conocimiento de Embarque:</label>
                    <span class="valor">${resultado.conocimientoEmbarque || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Manifiesto:</label>
                    <span class="valor">${resultado.manifiesto || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Peso:</label>
                    <span class="valor">${resultado.peso || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>CIF USD:</label>
                    <span class="valor">${resultado.cifUSD ? '$' + resultado.cifUSD.toLocaleString('es-CL') : 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Observaciones:</label>
                    <span class="valor">${resultado.observaciones || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Cantidad de Bultos:</label>
                    <span class="valor">${resultado.cantidadBultos || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Tipo de Bulto:</label>
                    <span class="valor">${resultado.tipoBulto || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Neto:</label>
                    <span class="valor">${resultado.neto ? '$' + resultado.neto.toLocaleString('es-CL') : 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>IVA:</label>
                    <span class="valor">${resultado.iva ? '$' + resultado.iva.toLocaleString('es-CL') : 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Total:</label>
                    <span class="valor">${resultado.total ? '$' + resultado.total.toLocaleString('es-CL') : 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Estado de Extracci√≥n:</label>
                    <span class="valor">${resultado.esValido ? '‚úÖ Documento v√°lido' : '‚ö†Ô∏è Documento incompleto'}</span>
                </div>
                <div class="dato-item">
                    <label>M√©todo de Extracci√≥n:</label>
                    <span class="valor">${resultado.metodoExtraccion || 'No especificado'}</span>
                </div>
                <div class="dato-item">
                    <label>Confianza de Extracci√≥n:</label>
                    <span class="valor">${resultado.confianzaExtraccion ? (resultado.confianzaExtraccion * 100).toFixed(1) + '%' : 'No especificado'}</span>
                </div>
            `;

            resultadosContainer.style.display = 'block';
        }

        async function analizarDocumentos() {
            // Verificar el tipo de documento seleccionado
            if (tipoDocumentoActual === 'di') {
                // Si est√° seleccionado DI, usar la funci√≥n espec√≠fica para DI
                await analizarSoloDI();
                return;
            }
            if (tipoDocumentoActual === 'dr') {
                await analizarSoloDR();
                return;
            }
            if (tipoDocumentoActual === 'tact') {
                await analizarSoloTACT();
                return;
            }
            if (tipoDocumentoActual === 'comprobante') {
                await analizarSoloComprobante();
                return;
            }
            if (tipoDocumentoActual === 'guiadespacho') {
                await analizarSoloGuiaDespacho();
                return;
            }

            // Para carn√© aduanero, verificar que exista el archivo
            const carneFile = document.getElementById('inputCarne').files[0];
            if (!carneFile) {
                alert('Por favor, selecciona el Carn√© Aduanero (campo requerido)');
                return;
            }

            const btnAnalizar = document.querySelector('.btn-analizar');
            btnAnalizar.disabled = true;
            btnAnalizar.innerHTML = '<span class="loading"></span> Analizando...';

            try {
                // Procesar el carn√© aduanero
                const formData = new FormData();
                formData.append('file', carneFile);

                const response = await fetch(`${API_BASE_URL}/procesar-imagen`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Procesar el texto OCR para extraer datos estructurados
                    const datosEstructurados = await procesarTextoOcr(result.texto);
                    
                    // Mostrar resultados
                    mostrarResultadosAnalisis(datosEstructurados, result);
                } else {
                    const error = await response.json();
                    alert('Error al procesar el carn√©: ' + error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al analizar los documentos: ' + error.message);
            } finally {
                btnAnalizar.disabled = false;
                btnAnalizar.innerHTML = '<span class="btn-icon">üîç</span> Analizar Documentos';
            }
        }

        async function analizarSoloDI() {
            const diFiles = Array.from(document.getElementById('inputDI').files);
            if (diFiles.length === 0) {
                alert('Por favor, selecciona la Declaraci√≥n de Ingreso (DI)');
                return;
            }

            // Buscar el bot√≥n correcto seg√∫n el contexto
            let btnAnalizar;
            if (tipoDocumentoActual === 'di') {
                // Si se llama desde el contexto de DI, usar el primer bot√≥n
                btnAnalizar = document.querySelector('.btn-analizar');
            } else {
                // Si se llama desde analizarDocumentos, usar el segundo bot√≥n
                btnAnalizar = document.querySelectorAll('.btn-analizar')[1];
            }
            
            btnAnalizar.disabled = true;
            btnAnalizar.innerHTML = '<span class="loading"></span> Analizando DI...';

            try {
                // Enviar todas las im√°genes en una sola solicitud
                const formData = new FormData();
                
                // Agregar todos los archivos al FormData
                diFiles.forEach((file, index) => {
                    formData.append('files', file);
                });

                const response = await fetch(`https://localhost:7001/api/DeclaracionIngreso/campos-criticos-multiple`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const resultadoFinal = await response.json();
                    // Mostrar resultados de DI
                    mostrarResultadosDI(resultadoFinal);
                } else {
                    const error = await response.json();
                    throw new Error(error.message);
                }
                
                // Mostrar resultados de DI
                mostrarResultadosDI(resultadoFinal);
            } catch (error) {
                console.error('Error:', error);
                alert('Error al analizar la DI: ' + error.message);
            } finally {
                btnAnalizar.disabled = false;
                // Restaurar el texto correcto seg√∫n el contexto
                if (tipoDocumentoActual === 'di') {
                    btnAnalizar.innerHTML = '<span class="btn-icon">üîç</span> Analizar Documentos';
                } else {
                    btnAnalizar.innerHTML = '<span class="btn-icon">üìã</span> Analizar Solo DI';
                }
            }
        }

        function mostrarResultadosDI(resultado) {
            const resultadosContainer = document.getElementById('resultadosAnalisis');
            const datosExtraidos = document.getElementById('datosExtraidos');

            const data = resultado.data || resultado;

            let archivosInfo = '';
            if (resultado.archivosProcesados) {
                archivosInfo = `
                    <div class="dato-item">
                        <label>Archivos Procesados:</label>
                        <span class="valor">${resultado.archivosProcesados} archivo(s) procesado(s)</span>
                    </div>
                `;
            }

            // Mostrar nombres de archivos si est√°n disponibles
            let archivosNombres = '';
            if (resultado.archivosNombres && resultado.archivosNombres.length > 0) {
                archivosNombres = `
                    <div class="dato-item">
                        <label>Archivos:</label>
                        <span class="valor">${resultado.archivosNombres.join(', ')}</span>
                    </div>
                `;
            }

            datosExtraidos.innerHTML = `
                ${archivosInfo}
                ${archivosNombres}
                <div class="dato-item">
                    <label>N√∫mero de Identificaci√≥n:</label>
                    <span class="valor">${data.numeroIdentificacion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Vencimiento:</label>
                    <span class="valor">${data.fechaVencimiento || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Tipo de Operaci√≥n:</label>
                    <span class="valor">${data.tipoOperacion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>C√≥digo de Tipo de Operaci√≥n:</label>
                    <span class="valor">${data.codigoTipoOperacion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Tipo de Bulto:</label>
                    <span class="valor">${data.tipoBulto || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Peso Bruto:</label>
                    <span class="valor">${data.pesoBruto || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Sello del Contenedor:</label>
                    <span class="valor">${data.selloContenedor || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Aceptaci√≥n:</label>
                    <span class="valor">${data.fechaAceptacion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Total a Pagar:</label>
                    <span class="valor">${data.totalPagar || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Estado de Extracci√≥n:</label>
                    <span class="valor">${resultado.camposExtraidos ? '‚úÖ Campos cr√≠ticos extra√≠dos correctamente' : '‚ö†Ô∏è Extracci√≥n incompleta'}</span>
                </div>
            `;

            resultadosContainer.style.display = 'block';
        }

        function mostrarResultadosAnalisis(datosEstructurados, resultadoOCR) {
            const resultadosContainer = document.getElementById('resultadosAnalisis');
            const datosExtraidos = document.getElementById('datosExtraidos');

            datosExtraidos.innerHTML = `
                <div class="dato-item">
                    <label>T√≠tulo del Documento:</label>
                    <span class="valor">${datosEstructurados.titulo || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Nombre Completo:</label>
                    <span class="valor">${datosEstructurados.nombreCompleto || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>RUT:</label>
                    <span class="valor">${datosEstructurados.rut || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>N√∫mero de Carn√©:</label>
                    <span class="valor">${datosEstructurados.numeroCarne || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Fecha de Emisi√≥n:</label>
                    <span class="valor">${datosEstructurados.fechaEmision || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>Resoluci√≥n:</label>
                    <span class="valor">${datosEstructurados.resolucion || 'No encontrado'}</span>
                </div>
                <div class="dato-item">
                    <label>M√©todo OCR Utilizado:</label>
                    <span class="valor">${resultadoOCR.metodo}</span>
                </div>
                <div class="dato-item">
                    <label>Texto Extra√≠do (OCR):</label>
                    <span class="valor" style="white-space: pre-wrap; max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">${resultadoOCR.texto}</span>
                </div>
            `;

            resultadosContainer.style.display = 'block';
        }

        // Funci√≥n para mostrar archivos seleccionados en el modal
        function mostrarArchivosSeleccionados(inputId) {
            const input = document.getElementById(inputId);
            const files = Array.from(input.files);
            
            // Buscar o crear contenedor para mostrar archivos
            let archivosContainer = document.getElementById(`${inputId}Archivos`);
            if (!archivosContainer) {
                archivosContainer = document.createElement('div');
                archivosContainer.id = `${inputId}Archivos`;
                archivosContainer.className = 'archivos-seleccionados';
                input.parentNode.appendChild(archivosContainer);
            }
            
            if (files.length === 0) {
                archivosContainer.innerHTML = '';
                return;
            }
            
            let html = '<div class="archivos-lista">';
            files.forEach((file, index) => {
                html += `
                    <div class="archivo-item">
                        <span class="archivo-nombre">${file.name}</span>
                        <span class="archivo-tama√±o">(${formatFileSize(file.size)})</span>
                        ${files.length > 1 ? `<span class="parte-indicator">Parte ${index + 1}</span>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            archivosContainer.innerHTML = html;
        }

        // Agregar event listeners para mostrar archivos seleccionados
        document.addEventListener('DOMContentLoaded', function() {
            const inputDI = document.getElementById('inputDI');
            if (inputDI) {
                inputDI.addEventListener('change', () => mostrarArchivosSeleccionados('inputDI'));
            }
        });

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('modalAnalisis');
            if (event.target === modal) {
                cerrarModal();
            }
        }

        // Funci√≥n para abrir el modal de an√°lisis
        function abrirModalAnalisis() {
            document.getElementById('modalAnalisis').style.display = 'block';
        }

        // Funci√≥n para seleccionar tipo de documento
        function seleccionarTipoDocumento(tipo) {
            tipoDocumentoActual = tipo;
            
            // Limpiar archivos seleccionados al cambiar tipo
            selectedFiles = [];
            
            // Actualizar botones
            document.querySelectorAll('.document-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Actualizar interfaz seg√∫n el tipo
            actualizarInterfazPorTipo(tipo);
            
            // Limpiar resultados anteriores
            document.getElementById('resultsSection').innerHTML = '';
        }

        // Funci√≥n para actualizar la interfaz seg√∫n el tipo de documento
        function actualizarInterfazPorTipo(tipo) {
            const uploadSection = document.querySelector('.upload-section');
            const processBtn = document.getElementById('processBtn');
            const diInfoSection = document.getElementById('diInfoSection');
            
            if (tipo === 'di') {
                // Mostrar informaci√≥n sobre documentos divididos
                diInfoSection.style.display = 'block';
                
                uploadSection.innerHTML = `
                    <div class="upload-icon">üìã</div>
                    <h3>Declaraci√≥n de Ingreso (DI)</h3>
                    <p>Sube archivos PDF o im√°genes PNG de Declaraciones de Ingreso para extraer los campos cr√≠ticos</p>
                    <p><strong>Nota:</strong> Si el documento est√° dividido en 2 partes, selecciona ambas im√°genes.</p>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf,.png,.jpg,.jpeg" multiple>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Seleccionar Archivos (PDF/PNG)
                    </button>
                    <div class="file-list" id="fileList"></div>
                    <button class="upload-btn" id="processBtn" onclick="processFiles()" disabled>
                        Procesar Declaraciones de Ingreso
                    </button>
                `;
                
                // Reconfigurar eventos
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });
            } else if (tipo === 'dr') {
                // Ocultar informaci√≥n sobre documentos divididos
                diInfoSection.style.display = 'none';
                
                uploadSection.innerHTML = `
                    <div class="upload-icon">üìÑ</div>
                    <h3>Documento de Recepci√≥n (DR)</h3>
                    <p>Sube una imagen PNG del Documento de Recepci√≥n para extraer informaci√≥n autom√°ticamente</p>
                    <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg" multiple>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Seleccionar Archivos (PNG/JPG)
                    </button>
                    <div class="file-list" id="fileList"></div>
                    <button class="upload-btn" id="processBtn" onclick="processFiles()" disabled>
                        Procesar Documentos de Recepci√≥n
                    </button>
                `;
                
                // Reconfigurar eventos
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });
            } else if (tipo === 'tact') {
                // Ocultar informaci√≥n sobre documentos divididos
                diInfoSection.style.display = 'none';
                
                uploadSection.innerHTML = `
                    <div class="upload-icon">üìã</div>
                    <h3>Documento TACT/ADC</h3>
                    <p>Sube una imagen PNG del documento TACT/ADC para extraer informaci√≥n autom√°ticamente</p>
                    <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg" multiple>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Seleccionar Archivos (PNG/JPG)
                    </button>
                    <div class="file-list" id="fileList"></div>
                    <button class="upload-btn" id="processBtn" onclick="processFiles()" disabled>
                        Procesar Documentos TACT/ADC
                    </button>
                `;
                
                // Reconfigurar eventos
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });
            } else if (tipo === 'comprobante') {
                // Ocultar informaci√≥n sobre documentos divididos
                diInfoSection.style.display = 'none';
                
                uploadSection.innerHTML = `
                    <div class="upload-icon">üßæ</div>
                    <h3>Comprobante de Transacci√≥n</h3>
                    <p>Sube una imagen PNG del comprobante de transacci√≥n para extraer informaci√≥n autom√°ticamente</p>
                    <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg" multiple>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Seleccionar Archivos (PNG/JPG)
                    </button>
                    <div class="file-list" id="fileList"></div>
                    <button class="upload-btn" id="processBtn" onclick="processFiles()" disabled>
                        Procesar Comprobantes de Transacci√≥n
                    </button>
                `;
                
                // Reconfigurar eventos
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });
            } else if (tipo === 'guiadespacho') {
                // Ocultar informaci√≥n sobre documentos divididos
                diInfoSection.style.display = 'none';
                
                uploadSection.innerHTML = `
                    <div class="upload-icon">üì¶</div>
                    <h3>Gu√≠a de Despacho Electr√≥nica</h3>
                    <p>Sube una imagen PNG de la Gu√≠a de Despacho Electr√≥nica para extraer informaci√≥n autom√°ticamente</p>
                    <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg" multiple>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Seleccionar Archivos (PNG/JPG)
                    </button>
                    <div class="file-list" id="fileList"></div>
                    <button class="upload-btn" id="processBtn" onclick="processFiles()" disabled>
                        Procesar Gu√≠as de Despacho
                    </button>
                `;
                
                // Reconfigurar eventos
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });
            } else {
                // Ocultar informaci√≥n sobre documentos divididos
                diInfoSection.style.display = 'none';
                
                uploadSection.innerHTML = `
                    <div class="upload-icon">üìÑ</div>
                    <h3>Carn√© Aduanero</h3>
                    <p>Sube archivos PDF de Carn√©s Aduaneros para extraer informaci√≥n autom√°ticamente</p>
                    <input type="file" id="fileInput" class="file-input" accept=".pdf" multiple>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Seleccionar Archivos PDF
                    </button>
                    <div class="file-list" id="fileList"></div>
                    <button class="upload-btn" id="processBtn" onclick="processFiles()" disabled>
                        Procesar Carn√©s Aduaneros
                    </button>
                `;
                
                // Reconfigurar eventos
                const fileInput = document.getElementById('fileInput');
                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                });
            }
        }

        // Funci√≥n modificada para procesar archivos seg√∫n el tipo
        async function processFiles() {
            if (selectedFiles.length === 0) return;

            const processBtn = document.getElementById('processBtn');
            processBtn.disabled = true;
            processBtn.innerHTML = '<span class="loading"></span> Procesando...';

            const results = [];

            if (tipoDocumentoActual === 'di') {
                // Procesar DI con manejo especial para m√∫ltiples im√°genes
                await procesarDIMultipleImagenes(results);
            } else if (tipoDocumentoActual === 'tact') {
                // Procesar TACT/ADC
                await procesarTACTMultipleImagenes(results);
            } else if (tipoDocumentoActual === 'comprobante') {
                // Procesar Comprobante de Transacci√≥n
                await procesarComprobanteMultipleImagenes(results);
            } else if (tipoDocumentoActual === 'guiadespacho') {
                // Procesar Gu√≠a de Despacho
                await procesarGuiaDespachoMultipleImagenes(results);
            } else {
                // Procesar carn√©s normalmente
                for (const file of selectedFiles) {
                    if (processingFiles.has(file.name)) continue;
                    
                    processingFiles.add(file.name);
                    updateProgress(file.name, 0);

                    try {
                        const formData = new FormData();
                        formData.append('file', file);

                        updateProgress(file.name, 25);

                        const response = await fetch(`${API_BASE_URL}/CarnetAduanero/procesar`, {
                            method: 'POST',
                            body: formData
                        });

                        updateProgress(file.name, 75);

                        if (response.ok) {
                            const result = await response.json();
                            results.push({ file, result, success: true });
                            updateProgress(file.name, 100);
                        } else {
                            const error = await response.json();
                            results.push({ file, error: error.message, success: false });
                            updateProgress(file.name, 100);
                        }
                    } catch (error) {
                        results.push({ file, error: error.message, success: false });
                        updateProgress(file.name, 100);
                    } finally {
                        processingFiles.delete(file.name);
                    }
                }
            }

            displayResults(results);
            updateStats(results);
            
            // Recargar datos despu√©s de procesar
            if (tipoDocumentoActual === 'carne') {
                loadStats();
                loadExistingCarnets();
            }
            
            processBtn.disabled = false;
            processBtn.innerHTML = tipoDocumentoActual === 'di' ? 'Procesar Declaraciones de Ingreso' : 'Procesar Carn√©s Aduaneros';
        }

        // Funci√≥n para procesar DI con m√∫ltiples im√°genes
        async function procesarDIMultipleImagenes(results) {
            const pdfFiles = selectedFiles.filter(f => f.type === 'application/pdf');
            const imageFiles = selectedFiles.filter(f => f.type.startsWith('image/'));

            // Procesar archivos PDF primero
            for (const file of pdfFiles) {
                await procesarArchivoDI(file, results);
            }

            // Procesar im√°genes individualmente o combinadas
            if (imageFiles.length === 1) {
                // Una sola imagen
                await procesarArchivoDI(imageFiles[0], results);
            } else if (imageFiles.length > 1) {
                // M√∫ltiples im√°genes - procesar cada una y combinar resultados
                const resultadosImagenes = [];
                
                for (const file of imageFiles) {
                    await procesarArchivoDI(file, resultadosImagenes);
                }

                // Combinar resultados de m√∫ltiples im√°genes
                if (resultadosImagenes.length > 0) {
                    const resultadoCombinado = combinarResultadosDI(resultadosImagenes);
                    results.push({
                        file: { name: `DI_Combinado_${imageFiles.length}_partes` },
                        result: resultadoCombinado,
                        success: true
                    });
                }
            }
        }

        // Funci√≥n para procesar un archivo DI individual
        // Funci√≥n para procesar TACT/ADC con m√∫ltiples im√°genes
        async function procesarTACTMultipleImagenes(results) {
            const imageFiles = selectedFiles.filter(f => f.type.startsWith('image/'));

            // Procesar im√°genes individualmente
            for (const file of imageFiles) {
                await procesarArchivoTACT(file, results);
            }
        }

        // Funci√≥n para procesar Comprobante de Transacci√≥n con m√∫ltiples im√°genes
        async function procesarComprobanteMultipleImagenes(results) {
            const imageFiles = selectedFiles.filter(f => f.type.startsWith('image/'));

            // Procesar im√°genes individualmente
            for (const file of imageFiles) {
                await procesarArchivoComprobante(file, results);
            }
        }

        async function procesarArchivoDI(file, results) {
            if (processingFiles.has(file.name)) return;
            
            processingFiles.add(file.name);
            updateProgress(file.name, 0);

            try {
                const formData = new FormData();
                formData.append('files', file);

                updateProgress(file.name, 25);

                const response = await fetch(`https://localhost:7001/api/DeclaracionIngreso/campos-criticos-multiple`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(file.name, 75);

                if (response.ok) {
                    const result = await response.json();
                    results.push({ file, result, success: true });
                    updateProgress(file.name, 100);
                } else {
                    const error = await response.json();
                    results.push({ file, error: error.message, success: false });
                    updateProgress(file.name, 100);
                }
            } catch (error) {
                results.push({ file, error: error.message, success: false });
                updateProgress(file.name, 100);
            } finally {
                processingFiles.delete(file.name);
            }
        }

        // Funci√≥n para combinar resultados de m√∫ltiples im√°genes DI
        // Funci√≥n para procesar un archivo TACT/ADC individual
        async function procesarArchivoTACT(file, results) {
            if (processingFiles.has(file.name)) return;
            
            processingFiles.add(file.name);
            updateProgress(file.name, 0);

            try {
                const formData = new FormData();
                formData.append('file', file);

                updateProgress(file.name, 25);

                const response = await fetch(`https://localhost:7001/api/TactAdc/procesar`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(file.name, 75);

                if (response.ok) {
                    const result = await response.json();
                    results.push({ file, result, success: true });
                    updateProgress(file.name, 100);
                } else {
                    const error = await response.json();
                    results.push({ file, error: error.message, success: false });
                    updateProgress(file.name, 100);
                }
            } catch (error) {
                results.push({ file, error: error.message, success: false });
                updateProgress(file.name, 100);
            } finally {
                processingFiles.delete(file.name);
            }
        }

        // Funci√≥n para procesar un archivo Comprobante de Transacci√≥n individual
        async function procesarArchivoComprobante(file, results) {
            if (processingFiles.has(file.name)) return;
            
            processingFiles.add(file.name);
            updateProgress(file.name, 0);

            try {
                const formData = new FormData();
                formData.append('file', file);

                updateProgress(file.name, 25);

                const response = await fetch(`https://localhost:7001/api/ComprobanteTransaccion/procesar`, {
                    method: 'POST',
                    body: formData
                });

                updateProgress(file.name, 75);

                if (response.ok) {
                    const result = await response.json();
                    results.push({ file, result, success: true });
                    updateProgress(file.name, 100);
                } else {
                    const error = await response.json();
                    results.push({ file, error: error.message, success: false });
                    updateProgress(file.name, 100);
                }
            } catch (error) {
                results.push({ file, error: error.message, success: false });
                updateProgress(file.name, 100);
            } finally {
                processingFiles.delete(file.name);
            }
        }

        function combinarResultadosDI(resultadosImagenes) {
            const resultadoCombinado = {
                status: true,
                message: "Resultados combinados de m√∫ltiples im√°genes",
                data: {},
                camposExtraidos: false
            };

            // Combinar campos de todas las im√°genes
            const camposCombinados = {};
            let camposEncontrados = 0;

            resultadosImagenes.forEach(({ result }) => {
                if (result.success && result.data) {
                    const data = result.data;
                    Object.keys(data).forEach(campo => {
                        if (data[campo] && data[campo] !== 'No encontrado' && !camposCombinados[campo]) {
                            camposCombinados[campo] = data[campo];
                            camposEncontrados++;
                        }
                    });
                }
            });

            resultadoCombinado.data = camposCombinados;
            resultadoCombinado.camposExtraidos = camposEncontrados > 0;

            return resultadoCombinado;
        }

        // Funci√≥n modificada para mostrar resultados seg√∫n el tipo
        function displayResults(results) {
            const resultsSection = document.getElementById('resultsSection');
            const titulo = tipoDocumentoActual === 'di' ? 'Resultados - Declaraciones de Ingreso' : 'Resultados - Carn√©s Aduaneros';
            resultsSection.innerHTML = `<h3>${titulo}</h3>`;

            results.forEach(({ file, result, error, success }) => {
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';

                if (success) {
                    if (tipoDocumentoActual === 'di') {
                        // Mostrar resultados de Declaraci√≥n de Ingreso
                        const data = result.data || result;
                        resultCard.innerHTML = `
                            <div class="result-header">
                                <div class="result-title">‚úÖ ${file.name}</div>
                                <div class="result-status status-success">Exitoso</div>
                            </div>
                            <div class="result-data">
                                <div class="data-item">
                                    <div class="data-label">N√∫mero de Identificaci√≥n</div>
                                    <div class="data-value">${data.numeroIdentificacion || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Fecha de Vencimiento</div>
                                    <div class="data-value">${data.fechaVencimiento || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Tipo de Operaci√≥n</div>
                                    <div class="data-value">${data.tipoOperacion || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Peso Bruto</div>
                                    <div class="data-value">${data.pesoBruto || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Sello del Contenedor</div>
                                    <div class="data-value">${data.selloContenedor || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Fecha de Aceptaci√≥n</div>
                                    <div class="data-value">${data.fechaAceptacion || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Total a Pagar</div>
                                    <div class="data-value">${data.totalPagar || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Campos Extra√≠dos</div>
                                    <div class="data-value">${result.camposExtraidos ? '‚úÖ Completos' : '‚ö†Ô∏è Incompletos'}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Mostrar resultados de Carn√© Aduanero (c√≥digo existente)
                        resultCard.innerHTML = `
                            <div class="result-header">
                                <div class="result-title">‚úÖ ${file.name}</div>
                                <div class="result-status status-success">Exitoso</div>
                            </div>
                            <div class="result-data">
                                <div class="data-item">
                                    <div class="data-label">N√∫mero de Carn√©</div>
                                    <div class="data-value">${result.numeroCarnet || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Titular</div>
                                    <div class="data-value">${result.nombreTitular || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">RUT</div>
                                    <div class="data-value">${result.rut || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Fecha de Emisi√≥n</div>
                                    <div class="data-value">${result.fechaEmision ? new Date(result.fechaEmision).toLocaleDateString('es-CL') : 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Resoluci√≥n</div>
                                    <div class="data-value">${result.resolucion || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">AGAD Cod</div>
                                    <div class="data-value">${result.agadCod || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Entidad Emisora</div>
                                    <div class="data-value">${result.entidadEmisora || 'No encontrado'}</div>
                                </div>
                                <div class="data-item">
                                    <div class="data-label">Confianza</div>
                                    <div class="data-value">${result.confianzaExtraccion ? (result.confianzaExtraccion * 100).toFixed(1) + '%' : 'N/A'}</div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    resultCard.innerHTML = `
                        <div class="result-header">
                            <div class="result-title">‚ùå ${file.name}</div>
                            <div class="result-status status-error">Error</div>
                        </div>
                        <div class="error-message">
                            <strong>Error:</strong> ${error}
                        </div>
                    `;
                }

                resultsSection.appendChild(resultCard);
            });
        }

        // Cargar datos al iniciar
        loadStats();
        loadExistingCarnets();
    </script>
</body>
</html> 